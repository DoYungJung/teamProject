<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.example.sample.restaurant.service.impl.RestaurantMapper">

	<resultMap id="restaurant" type="egovframework.example.sample.restaurant.service.RestaurantVO">
		<!-- 필요없는 부분은 제거(User Table) -->
		<result property="userId" column="user_id"/>
		<result property="userPw" column="user_pw"/>
		<result property="userNm" column="user_name"/>
		<result property="useYn" column="use_yn"/>
		
		<!-- 필요없는 부분은 제거(Review Table) -->
		<result property="idx" column="idx"/>
		<result property="restaurantNo" column="restaurant_no"/>
		<result property="title" column="title"/>
		<result property="content" column="content"/>
		<result property="writerNm" column="writer_name"/>
		<result property="writerId" column="writer_id"/>
		<result property="regDate" column="reg_date"/>
		<result property="modDate" column="mod_date"/>
		<result property="count" column="count"/>
		
		
		
	</resultMap>
	
	
	<!-- 각 쿼리의 내부 SQL 쿼리 수정할 필요 있음 -->
	<insert id="insertReview" parameterType="restaurantVO">

			INSERT INTO SAMPLE
				( ID
				  , NAME
				  , DESCRIPTION
				  , USE_YN
				  , REG_USER )
			VALUES ( #{id}
				  , #{name}
				  , #{description}
				  , #{useYn}
				  , #{regUser} )

	</insert>

	<update id="updateReview">

			UPDATE SAMPLE
			SET ID=#{id}
				, NAME=#{name}
				, DESCRIPTION=#{description}
				, USE_YN=#{useYn}
				  WHERE ID=#{id}

	</update>

	<delete id="deleteReview">

			DELETE FROM SAMPLE
			WHERE ID=#{id}

	</delete>
	
	<!-- 식당 상세 테이블을 조인하여 식당이름을 옆에 붙이자 -->
	<select id="selectReview" parameterType="restaurantVO" resultMap="restaurant">

			SELECT A.review_no
				, A.restaurant_no
				, A.title
				, A.content
				, A.writer_name
				, A.writer_id
				, A.reg_date
				, A.mod_date
				, A.count
			FROM tbl_review A
			WHERE 1=1
			AND A.restaurante_no = #{restaurantNo}
			ORDER BY A.review_no DESC
			LIMIT #{firstIndex} #{recordCountPerPage}

	</select>
	
	<!-- 상세 식당 테이블과 식당 id로 조인하여 식당이름을 옆에 붙여야한다 -->
	<!-- 상세 식당 테이블별 리뷰 가져오는 조건 추가 -->
	<!-- selectRestaurant와 selectRestaurantList간의 페이징처리하는 개수가 다르기 때문에 LIMIT 서로 다르게 수정 필요 -->
	<select id="selectReviewList" parameterType="restaurantVO" resultType="egovMap">

			SELECT A.idx
				, A.restaurant_no
				, A.title
				, A.content
				, A.writer_name
				, A.writer_id
				, A.reg_date
				, A.mod_date
				, A.count
			FROM tbl_review A
			WHERE 1=1
			<if test="searchKeyword != null and searchKeyword != ''">
			AND ( A.TITLE LIKE CONCAT('%', #{searchKeyword}, '%'))
			</if>
			ORDER BY A.idx DESC
			LIMIT #{firstIndex} #{recordCountPerPage}
			
	</select>
	
	<!-- 상세 식당 페이지의 리뷰의 개수를 가져오는 쿼리 추가 -->
	<select id="selectReviewListTotCnt" parameterType="restaurantVO" resultType="int">

			SELECT COUNT(*) totcnt
			FROM tbl_review A
			WHERE 1=1
			<if test="searchKeyword != null and searchKeyword != ''">
			AND ( A.title LIKE CONCAT('%', #{searchKeyword}, '%'))
			</if>
	</select>
	
	
	
	

</mapper>